<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逆向JS配置管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #6366f1;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --background-color: #f9fafb;
            --card-background: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .navbar {
            background-color: var(--card-background);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }

        .navbar-brand {
            color: var(--primary-color) !important;
            font-weight: 600;
            font-size: 1.5rem;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .card {
            background-color: var(--card-background);
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .card-header {
            background-color: transparent;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            border-top: none;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .table td {
            vertical-align: middle;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .modal-content {
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background-color: var(--background-color);
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .modal-footer {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background-color: var(--background-color);
            border-radius: 0 0 0.5rem 0.5rem;
        }

        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-control {
            border-radius: 0.375rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0.75rem;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }

        .table-responsive {
            border-radius: 0.5rem;
            background-color: var(--card-background);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .table-responsive {
                margin: 0 -1rem;
                width: calc(100% + 2rem);
            }

            .main-container {
                padding: 1rem;
            }

            .card-header {
                padding: 0.75rem;
            }

            .table th, .table td {
                white-space: nowrap;
            }

            .btn-sm {
                padding: 0.25rem 0.5rem;
            }
        }

        /* 自定义滚动条 */
        .table-responsive::-webkit-scrollbar {
            height: 6px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 表格内容溢出处理 */
        .table td {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* 操作列保持一行显示所有按钮，给足宽度避免被裁切 */
        .table td.td_actions {
            max-width: none;
            min-width: 320px;
            overflow: visible;
            white-space: nowrap;
        }

        /* 操作按钮样式 */
        .btn-action {
            padding: 0.25rem 0.5rem;
            margin: 0 0.25rem;
        }

        .btn-action i {
            font-size: 0.875rem;
        }

        .btn_action_text {
            font-size: 0.75rem;
        }

        /* 加载动画 */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <span class="navbar-brand">逆向JS配置管理</span>
        </div>
    </nav>

    <!-- 主容器 -->
    <div class="main-container">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">配置列表</h5>
                <button class="btn btn-primary" onclick="showAddModal()">
                    <i class="bi bi-plus"></i> 添加配置
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>API名称</th>
                            <th>用户名</th>
                            <th>源网站</th>
                            <!-- 暂时隐藏：JS URL、断点行号、断点列号、目标函数 -->
                            <th>覆盖函数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="configTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 添加/编辑模态框 -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">添加配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="configForm" class="row g-3">
                        <input type="hidden" id="configId">
                        <div class="col-md-6" id="apiNameRow" style="display: none;">
                            <label class="form-label">API名称</label>
                            <input type="text" class="form-control" id="apiName" readonly>
                            <small class="text-muted">API名称由系统自动生成且不可修改</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="userName">用户名 *</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="sourceWebsite">源网站 *</label>
                            <input type="text" class="form-control" id="sourceWebsite" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="hijackJsUrl">JS URL *</label>
                            <input type="text" class="form-control" id="hijackJsUrl" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="breakpointLineNum">断点行号 *</label>
                            <input type="number" class="form-control" id="breakpointLineNum" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="breakpointColNum">断点列号 *</label>
                            <input type="number" class="form-control" id="breakpointColNum" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="targetFunc">注入函数代码 *</label>
                            <textarea class="form-control" id="targetFunc" required rows="10" placeholder="async (data) => {&#10;    // 编写获取数据逻辑&#10;    return data&#10;}"></textarea>
                            <small class="text-muted">请输入要注入的代码</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="paramsExample">参数示例</label>
                            <textarea class="form-control" id="paramsExample" rows="3" placeholder='[1, "example", {"key": "value"}]'></textarea>
                            <small class="text-muted">请输入JSON格式的参数示例数组</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="overrideFuncs">覆盖函数</label>
                            <input type="text" class="form-control" id="overrideFuncs" placeholder="setTimeout,setInterval" value="setTimeout,setInterval">
                            <small class="text-muted">要覆盖的JavaScript函数，用逗号分隔</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">触发JS</label>
                            <textarea class="form-control" id="triggerJs" rows="3" placeholder="在页面加载时执行的JavaScript代码"></textarea>
                            <small class="text-muted">页面加载时要执行的自定义JavaScript代码</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Cookies</label>
                            <textarea class="form-control" id="cookies" rows="3" placeholder='name1=value1; name2=value2; domain=.example.com'></textarea>
                            <small class="text-muted">设置页面的Cookies，使用标准Cookie字符串格式，如：name1=value1; name2=value2; domain=.example.com</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                            <small class="text-muted">* 表示必填字段</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 测试模态框 -->
    <div class="modal fade" id="testModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">API测试</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">API名称</label>
                        <input type="text" class="form-control" id="testApiName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">参数 (JSON格式数组)</label>
                        <textarea class="form-control" id="testParams" rows="5" placeholder='["参数1", "参数2", ...]'></textarea>
                        <small class="text-muted">请输入JSON格式的数组，作为调用API的参数</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">响应结果</label>
                        <pre id="testResult" class="form-control" style="min-height: 200px; white-space: pre-wrap;"></pre>
                    </div>
                    <div id="curlCommandContainer" class="mb-3" style="display: none;">
                        <pre id="curlCommand" class="form-control" style="min-height: 100px; white-space: pre-wrap;"></pre>
                    </div>
                    <div id="copySuccess" class="alert alert-success mt-2" style="display: none;">
                        curl命令已复制到剪贴板！
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-info" id="copyCurlBtn" onclick="copyCurlCommand()">
                        <i class="bi bi-clipboard"></i> 复制curl命令
                    </button>
                    <button type="button" class="btn btn-primary" onclick="runApiTest()">发送请求</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 执行JS模态框 -->
    <div class="modal fade" id="executeJsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">执行JavaScript</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">API名称</label>
                        <input type="text" class="form-control" id="executeJsApiName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">JavaScript代码</label>
                        <textarea class="form-control" id="jsCode" rows="10" placeholder="输入要执行的JavaScript代码"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input class="form-check-input" type="checkbox" id="isAsync">
                        <label class="form-check-label" for="isAsync">
                            异步执行（适用于包含await的代码）
                        </label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">执行结果</label>
                        <pre id="jsResult" class="form-control" style="min-height: 200px; white-space: pre-wrap;"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="executeJs()">执行</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div class="loading" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        let configModal;
        let currentMode = 'add';
        let testModal;
        let executeJsModal;
        let currentTestApiName;
        const loading = document.querySelector('.loading');

        document.addEventListener('DOMContentLoaded', function() {
            configModal = new bootstrap.Modal(document.getElementById('configModal'));
            testModal = new bootstrap.Modal(document.getElementById('testModal'));
            executeJsModal = new bootstrap.Modal(document.getElementById('executeJsModal'));
            loadConfigs(); 
        });

        function showLoading() {
            loading.style.display = 'flex';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function showAddModal() {
            // 重置表单
            document.getElementById('configForm').reset();
            
            // 设置标题
            document.getElementById('modalTitle').textContent = '添加配置';
            
            // 隐藏API名称行
            document.getElementById('apiNameRow').style.display = 'none';
            
            // 设置当前模式
            currentMode = 'add';
            
            configModal.show();
        }

        function formatDateTimeLocal(date) {
            return new Date(date.getTime() - date.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toISOString()
                .replace('T', ' ')
                .slice(0, 19);
        }

        // 添加一个辅助函数，安全地设置triggerJs的值
        function safeSetTriggerJs(element, code) {
            // 直接使用DOM API设置值，避免HTML属性中的引号问题
            element.value = code || '';
        }

        async function showEditModal(config) {
            // 重置表单
            document.getElementById('configForm').reset();
            
            // 设置当前模式
            currentMode = 'edit';
            
            // 填充表单数据
            document.getElementById('configId').value = config.id;
            document.getElementById('apiName').value = config.api_name;
            document.getElementById('userName').value = config.user_name;
            document.getElementById('sourceWebsite').value = config.source_website;
            document.getElementById('hijackJsUrl').value = config.hijack_js_url;
            document.getElementById('breakpointLineNum').value = config.breakpoint_line_num;
            document.getElementById('breakpointColNum').value = config.breakpoint_col_num;
            document.getElementById('targetFunc').value = config.target_func;
            document.getElementById('overrideFuncs').value = config.override_funcs || 'setTimeout,setInterval';
            
            // 添加对params_example的JSON美化处理
            if (config.params_example) {
                try {
                    // 尝试解析并美化JSON
                    const parsedParams = JSON.parse(config.params_example);
                    document.getElementById('paramsExample').value = JSON.stringify(parsedParams, null, 2);
                } catch (e) {
                    // 如果解析失败，直接使用原始字符串
                    document.getElementById('paramsExample').value = config.params_example || '';
                }
            } else {
                document.getElementById('paramsExample').value = '';
            }
            
            // 安全地设置触发JS字段，避免HTML引号冲突
            safeSetTriggerJs(document.getElementById('triggerJs'), config.trigger_js);
            document.getElementById('cookies').value = config.cookies || '';
            document.getElementById('description').value = config.description || '';

            // 显示API名称行
            document.getElementById('apiNameRow').style.display = 'block';
            
            // 设置标题
            document.getElementById('modalTitle').textContent = '编辑配置';
            
            // 显示模态框
            configModal.show();
        }

        async function showTestModal(config) {
            const modal = document.getElementById('testModal');
            // 设置当前测试的API名称
            currentTestApiName = config.api_name;
            // 替换原有的不存在的元素引用
            document.getElementById('testApiName').value = config.api_name || `配置 #${config.id}`;
            
            // 如果有参数示例，自动填充到测试参数
            if (config.params_example) {
                try {
                    // 尝试解析并美化JSON
                    const parsedParams = JSON.parse(config.params_example);
                    document.getElementById('testParams').value = JSON.stringify(parsedParams, null, 2);
                } catch (e) {
                    // 如果解析失败，直接使用原始字符串
                    document.getElementById('testParams').value = config.params_example;
                }
            } else {
                document.getElementById('testParams').value = '[]';
            }
            
            // 清空测试结果
            document.getElementById('testResult').textContent = '';
            
            // 显示模态框
            testModal.show();
        }

        async function runApiTest() {
            try {
                const paramsField = document.getElementById('testParams');
                const resultField = document.getElementById('testResult');
                const curlCommandContainer = document.getElementById('curlCommandContainer');
                const curlCommandField = document.getElementById('curlCommand');
                
                // 隐藏可能显示的复制成功信息
                document.getElementById('copySuccess').style.display = 'none';
                
                // 解析参数
                let params;
                try {
                    params = JSON.parse(paramsField.value);
                    // if (!Array.isArray(params)) {
                    //     throw new Error('参数必须是数组格式');
                    // }
                } catch (e) {
                    resultField.textContent = `参数解析错误: ${e.message}`;
                    resultField.className = 'form-control text-danger';
                    curlCommandContainer.style.display = 'none';
                    return;
                }
                
                showLoading();
                resultField.textContent = '请求中...';
                
                // 保存请求信息以供生成curl命令
                const apiUrl = `/api/antijs/${currentTestApiName}`;
                const requestBody = JSON.stringify({ data: params });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'debug': 'true'
                    },
                    body: requestBody
                });
                
                const result = await response.json();
                resultField.textContent = JSON.stringify(result, null, 2);
                
                // 根据新的返回格式判断成功失败
                if (result.code === 0) {
                    resultField.className = 'form-control text-success';
                } else {
                    resultField.className = 'form-control text-danger';
                }
                
                // 生成curl命令
                const curlCmd = generateCurlCommand(apiUrl, requestBody);
                curlCommandField.textContent = curlCmd;
                curlCommandContainer.style.display = 'block';
                
            } catch (error) {
                console.error('API测试失败:', error);
                document.getElementById('testResult').textContent = `请求失败: ${error.message}`;
                document.getElementById('testResult').className = 'form-control text-danger';
                document.getElementById('curlCommandContainer').style.display = 'none';
            } finally {
                hideLoading();
            }
        }

        // 生成curl命令
        function generateCurlCommand(url, body) {
            // 获取完整的URL（包含域名）
            const fullUrl = new URL(url, window.location.origin).href;
            
            // 构建curl命令
            let curlCmd = `curl -X POST "${fullUrl}" \\
  -H "Content-Type: application/json" \\
  -d '${body}'`;
            
            return curlCmd;
        }

        // 复制curl命令到剪贴板
        function copyCurlCommand() {
            try {
                // 隐藏可能显示的复制成功信息
                document.getElementById('copySuccess').style.display = 'none';
                
                // 解析参数
                const paramsField = document.getElementById('testParams');
                let params;
                
                try {
                    params = JSON.parse(paramsField.value);
                    // if (!Array.isArray(params)) {
                    //     throw new Error('参数必须是数组格式');
                    // }
                } catch (e) {
                    alert(`参数解析错误: ${e.message}`);
                    return;
                }
                
                // 生成curl命令
                const apiUrl = `/api/antijs/${currentTestApiName}`;
                const requestBody = JSON.stringify({ data: params });
                const curlCmd = generateCurlCommand(apiUrl, requestBody);
                
                // 复制到剪贴板
                navigator.clipboard.writeText(curlCmd)
                    .then(() => {
                        // 显示复制成功信息
                        document.getElementById('copySuccess').style.display = 'block';
                        
                        // 2秒后隐藏成功信息
                        setTimeout(() => {
                            document.getElementById('copySuccess').style.display = 'none';
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        alert('复制失败，请手动复制。');
                    });
            } catch (error) {
                console.error('生成curl命令失败:', error);
                alert('生成curl命令失败: ' + error.message);
            }
        }

        async function loadConfigs() {
            try {
                showLoading();
                
                // 获取配置列表（现在已包含调用次数信息）
                const response = await fetch('/internal/api/configs', { credentials: 'include' });
                
                if (response.status === 401) {
                    window.location.href = '/admin';
                    return;
                }
                
                const configs = await response.json();
                
                if (!response.ok) {
                    throw new Error((await response.json()).detail || '加载配置失败');
                }
                
                const tbody = document.getElementById('configTable');
                tbody.innerHTML = '';
                
                // 直接渲染列表，配置中已包含调用次数数据
                configs.forEach(config => {
                    const tr = document.createElement('tr');
                    
                    // 根据调用次数百分比设置样式
                    let usageStatus = '';
                    if (config.max_calls) {
                        const percentage = config.call_percentage || 0;
                        
                        if (percentage >= 90) {
                            usageStatus = '<span class="badge bg-danger">即将耗尽</span>';
                        } else if (percentage >= 70) {
                            usageStatus = '<span class="badge bg-warning">使用中</span>';
                        } else {
                            usageStatus = '<span class="badge bg-info">正常</span>';
                        }
                    }
                    
                    // 创建编辑按钮
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-primary btn-action';
                    editBtn.title = '编辑';
                    editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                    editBtn.onclick = function() {
                        showEditModal(config);
                    };
                    
                    // 创建删除按钮
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-action';
                    deleteBtn.title = '删除';
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteBtn.onclick = function() {
                        deleteConfig(config.id);
                    };
                    
                    // 创建测试按钮
                    const testBtn = document.createElement('button');
                    testBtn.className = 'btn btn-success btn-action';
                    testBtn.title = '测试';
                    testBtn.innerHTML = '<i class="bi bi-play"></i>';
                    testBtn.onclick = function() {
                        showTestModal(config);
                    };
                    
                    tr.innerHTML = `
                        <td>${config.id}</td>
                        <td>${config.api_name}</td>
                        <td>${config.user_name}</td>
                        <td title="${config.source_website}">${config.source_website}</td>
                        <td>${config.override_funcs || 'setTimeout,setInterval'}</td>
                        <td class="td_actions" id="actions_${config.id}"></td>
                    `;
                    tbody.appendChild(tr);

                    const actionsCell = document.getElementById(`actions_${config.id}`);
                    actionsCell.appendChild(editBtn);
                    actionsCell.appendChild(deleteBtn);
                    actionsCell.appendChild(testBtn);

                    const execJsBtn = document.createElement('button');
                    execJsBtn.className = 'btn btn-secondary btn-action btn_action_text';
                    execJsBtn.title = '执行JS';
                    execJsBtn.textContent = '执行js';
                    execJsBtn.onclick = function() {
                        showExecuteJsModal(config.api_name);
                    };
                    actionsCell.appendChild(execJsBtn);

                    const snapshotBtn = document.createElement('button');
                    snapshotBtn.className = 'btn btn-info btn-action btn_action_text';
                    snapshotBtn.title = '查看截图';
                    snapshotBtn.textContent = '截图';
                    snapshotBtn.onclick = function() {
                        viewSnapshot(config.api_name);
                    };
                    actionsCell.appendChild(snapshotBtn);

                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'btn btn-warning btn-action btn_action_text';
                    closeBtn.title = '关闭页面';
                    closeBtn.textContent = '关闭';
                    closeBtn.onclick = function() {
                        closePage(config.api_name);
                    };
                    actionsCell.appendChild(closeBtn);
                });
            } catch (error) {
                console.error('加载配置失败:', error);
                alert('加载失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function saveConfig() {
            try {
                showLoading();

                // 验证必填字段
                const requiredFields = ['userName', 'sourceWebsite', 'hijackJsUrl', 'breakpointLineNum', 'breakpointColNum', 'targetFunc'];
                for (const field of requiredFields) {
                    const element = document.getElementById(field);
                    if (!element.value.trim()) {
                        const labelEl = element.labels && element.labels[0];
                        const labelText = labelEl ? labelEl.textContent.replace(/\s*\*\s*$/, '').trim() : field;
                        alert(`请填写${labelText}`);
                        element.focus();
                        hideLoading();
                        return;
                    }
                }

                // 处理参数示例JSON格式
                let paramsExample = document.getElementById('paramsExample').value.trim();
                if (paramsExample) {
                    try {
                        JSON.parse(paramsExample);
                    } catch (e) {
                        alert('参数示例格式错误，请输入有效的JSON');
                        document.getElementById('paramsExample').focus();
                        hideLoading();
                        return;
                    }
                }

                // cookies 已改为字符串格式，不需要检查 JSON 格式
                let cookies = document.getElementById('cookies').value.trim();
                const triggerJs = document.getElementById('triggerJs').value || null;

                const config = {
                    user_name: document.getElementById('userName').value,
                    source_website: document.getElementById('sourceWebsite').value,
                    hijack_js_url: document.getElementById('hijackJsUrl').value,
                    breakpoint_line_num: parseInt(document.getElementById('breakpointLineNum').value),
                    breakpoint_col_num: parseInt(document.getElementById('breakpointColNum').value),
                    target_func: document.getElementById('targetFunc').value,
                    params_example: paramsExample || null,
                    description: document.getElementById('description').value || null,
                    override_funcs: document.getElementById('overrideFuncs').value,
                    trigger_js: triggerJs,
                    cookies: cookies || null
                };

                let url = '/internal/api/configs';
                let method = 'POST';
                
                if (currentMode === 'edit') {
                    const configId = document.getElementById('configId').value;
                    url = `/internal/api/configs/${configId}`;
                    method = 'PUT';
                    config.id = parseInt(configId);
                    config.api_name = document.getElementById('apiName').value;
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config),
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || '保存失败');
                }
                
                // alert(currentMode === 'add' ? '添加成功！' : '更新成功！');
                configModal.hide();
                loadConfigs();
                
            } catch (error) {
                console.error('保存配置失败:', error);
                alert('保存失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteConfig(id) {
            if (!confirm('确定要删除这条配置吗？')) {
                return;
            }

            try {
                showLoading();
                const response = await fetch(`/internal/api/configs/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    window.location.href = '/admin';
                    return;
                }

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || '删除失败');
                }

                loadConfigs();
            } catch (error) {
                console.error('删除配置失败:', error);
                alert('删除失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        /** 调用服务端截图接口，保存到 snapshots 并在新标签页打开查看 */
        async function viewSnapshot(apiName) {
            try {
                showLoading();
                const response = await fetch(`/internal/api/snapshot?api_name=${encodeURIComponent(apiName)}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    window.location.href = '/admin';
                    return;
                }

                const result = await response.json();
                hideLoading();

                if (response.ok && result.url) {
                    window.open(result.url, '_blank');
                } else {
                    alert(result.detail || result.message || '截图失败');
                }
            } catch (error) {
                hideLoading();
                alert('截图请求失败: ' + error.message);
            }
        }

        async function closePage(apiName) {
            if (!confirm(`确定要关闭 ${apiName} 的页面吗？`)) {
                return;
            }

            try {
                showLoading();
                const response = await fetch(`/internal/api/close_page/${apiName}`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    window.location.href = '/admin';
                    return;
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || '关闭页面失败');
                }

                // 更新配置列表以反映页面状态变化
                loadConfigs();
            } catch (error) {
                console.error('关闭页面失败:', error);
                alert('关闭页面失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showExecuteJsModal(apiName) {
            document.getElementById('executeJsApiName').value = apiName;
            // 使用安全方法设置空值
            safeSetTriggerJs(document.getElementById('jsCode'), '');
            document.getElementById('jsResult').textContent = '';
            document.getElementById('isAsync').checked = false;
            executeJsModal.show();
        }

        async function executeJs() {
            try {
                showLoading();
                const apiName = document.getElementById('executeJsApiName').value;
                const jsCode = document.getElementById('jsCode').value;
                const isAsync = document.getElementById('isAsync').checked;

                if (!jsCode.trim()) {
                    alert('请输入要执行的JavaScript代码');
                    hideLoading();
                    return;
                }

                const response = await fetch(`/internal/api/execute_js/${apiName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        javascript: jsCode,
                        is_async: isAsync
                    }),
                    credentials: 'include'
                });

                if (response.status === 401) {
                    window.location.href = '/admin';
                    return;
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || '执行JavaScript失败');
                }

                // 显示执行结果
                document.getElementById('jsResult').textContent = typeof result.result === 'object' 
                    ? JSON.stringify(result.result, null, 2) 
                    : result.result;
            } catch (error) {
                console.error('执行JavaScript失败:', error);
                document.getElementById('jsResult').textContent = `错误: ${error.message}`;
            } finally {
                hideLoading();
            }
        }

        // 每30秒自动刷新页面状态（可选）
        // setInterval(loadConfigs, 30000);
    </script>
</body>
</html>